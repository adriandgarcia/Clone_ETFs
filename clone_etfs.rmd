---
title: "Clone ETFs"
knit: (function(input_file, encoding) {
  out_dir <- 'docs';
  rmarkdown::render(input_file,
 encoding=encoding,
 output_file=file.path(dirname(input_file), out_dir, 'index.html'))})
author: "Adrian D. Garcia"
date: "August 2020"
output:
  html_document:
    toc: true
    toc_float: true
---

# Getting Started

```{r setup, message=FALSE, warning=FALSE}

library(tidyverse) #For Data Analysis
library(lubridate) #For working with dates
library(DT) #For visualizing tables

```

## Data

First, I pulled in the mutual fund data from Morningstar Direct. (I combined it using “combine_files.r”). There were 25,264 rows and 43 columns. I also pulled in ETF data from Morninstar. There were 2,417 rows and 44 columns. Data was pulled from Morningstar Direct on Aug. 18, 2020.

I combine these two data sets to create a dataset of mutual funds and ETFs, 27,681 rows, 44 columns.


```{r data_upload, message=FALSE}

MFs <- read_csv("~/Data/Clone_ETFs/Mutual_Funds/MS_MFS_081820_Full.csv",
                 guess_max = 25000) %>% 
  mutate(TYPE = "MUTUAL FUND")


ETFs <- read_csv("~/Data/Clone_ETFs/ETFs/MS_ETFS_081820_Full.csv",
                 guess_max = 25000) %>% 
  mutate(TYPE = "ETF")

Data <- full_join(ETFs, MFs) %>% 
  rename_all(make.names)

```

## Matching

I would like to take the full dataset created above and find cases where mutual funds and etfs match at the same shop. The easiest, most accurate way I've found to do this is to look at the following three combinations:

* A fund's strategy and its management company
* A fund's strategy and its branding name
* A fund's strategy and it's firm name

I can cross reference these individual dataframes by each other to come up with 524 funds.

A setback to this approach is that there are 406 rows without a strategy name. I isolated these funds and compared them to each other by their fund name (minus the last word which is usually the shareclass type). I found no matches.

```{r matching, message=FALSE}

Management <- Data %>% 
  group_by(Strategy.Name, Management.Company, TYPE) %>% 
  summarise(COUNT = n()) %>% 
  pivot_wider(names_from = TYPE, values_from = COUNT) %>% 
  group_by(Strategy.Name, Management.Company)

Mgt_Matches <- Management %>%
  filter(!is.na(`MUTUAL FUND`) &
           !is.na(ETF))

Mgt_Matches_df <- Data %>% 
  filter(Strategy.Name %in% Mgt_Matches$Strategy.Name &
           !is.na(Management.Company))

###

Branding <- Data %>% 
  group_by(Strategy.Name, Branding.Name, TYPE) %>% 
  summarise(COUNT = n()) %>% 
  pivot_wider(names_from = TYPE, values_from = COUNT) %>% 
  group_by(Strategy.Name, Branding.Name)

Brand_Matches <- Branding %>%
  filter(!is.na(`MUTUAL FUND`) &
           !is.na(ETF))

Brand_Matches_df <- Data %>% 
  filter(Strategy.Name %in% Brand_Matches$Strategy.Name &
           !is.na(Branding.Name) &
           !is.na(Strategy.Name)) 

###

Firm <- Data %>% 
  group_by(Strategy.Name, Firm.Name, TYPE) %>% 
  summarise(COUNT = n()) %>% 
  pivot_wider(names_from = TYPE, values_from = COUNT) %>% 
  group_by(Strategy.Name, Firm.Name)

Firm_Matches <- Firm %>%
  filter(!is.na(`MUTUAL FUND`) &
           !is.na(ETF))

Firm_Matches_df <- Data %>% 
  filter(Strategy.Name %in% Firm_Matches$Strategy.Name &
           !is.na(Firm.Name) &
           !is.na(Strategy.Name))

Combined_matches <- full_join(Mgt_Matches_df, Brand_Matches_df) %>% 
  full_join(., Firm_Matches_df)

# Blanks <- Data %>%
#   filter(is.na(Strategy.Name)) %>%
#   mutate(Name.Mod = str_replace(Name, "\\s\\w*(™)?$", "")) %>%
#   select(Name, Name.Mod, TYPE, everything()) %>%
#   group_by(Name.Mod, TYPE) %>%
#   summarise(COUNT = n()) %>%
#   pivot_wider(names_from = TYPE, values_from = COUNT)

```


```{r matches_show, echo=FALSE}

Combined_matches %>%
  group_by(Strategy.Name, Firm.Name, TYPE) %>% 
  summarise(COUNT = n()) %>% 
  pivot_wider(names_from = TYPE, values_from = COUNT) %>% 
  group_by(Strategy.Name, Firm.Name) %>% 
  datatable()

```

To reduce the chance that funds were missed either because the strategy is blank  or slightly different I can compare funds based on their names (minus the last word where the shareclass typicall is located).

I come up with 149 funds that match. I can then cross reference that list against the list I created above to add the ones I'm missing. I go from 524 matches to 581 matches.

```{r name_matches, message=FALSE}

Names <- Data %>% 
  mutate(Name.Mod = str_replace(Name, "\\s\\w*(™)?$", "")) %>% 
  select(Name, Name.Mod, TYPE, everything()) %>% 
  group_by(Name.Mod, TYPE) %>% 
  count() %>% 
  pivot_wider(names_from = TYPE, values_from = n) %>% 
  filter(!is.na(`MUTUAL FUND`)&!is.na(ETF))

Names_Matches_df <- Data %>% 
  mutate(Name.Mod = str_replace(Name, "\\s\\w*(™)?$", "")) %>% 
  filter(Name.Mod %in% Names$Name.Mod)


Combined_matches <- full_join(Combined_matches, Names_Matches_df)

write_csv(Combined_matches, "Matched_Data.csv")

```


```{r, name_matches_show, echo=FALSE}

Combined_matches %>%
  group_by(Strategy.Name, Firm.Name, TYPE) %>% 
  summarise(COUNT = n()) %>% 
  pivot_wider(names_from = TYPE, values_from = COUNT) %>% 
  group_by(Strategy.Name, Firm.Name) %>% 
  datatable()

```